name: release-nginx

on:
  workflow_dispatch:

jobs:
  create_release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: manual-${{ github.run_id }}
          name: Manual Release ${{ github.run_id }}
          draft: false
          prerelease: false

  build_and_upload:
    needs: create_release
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            distro: debian
            artifact_name: nginx-debian-amd64.tar.gz
            tag: manual-${{ github.run_id }}
          - os: ubuntu-latest
            distro: centos
            artifact_name: nginx-centos8-amd64.tar.gz
            tag: manual-${{ github.run_id }}
          - os: windows-latest
            distro: windows
            artifact_name: nginx-windows-amd64.zip
            tag: manual-${{ github.run_id }}
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Build on Debian
        if: ${{ matrix.distro == 'debian' }}
        shell: bash
        run: |
          sudo apt update
          sudo apt install -y build-essential libpcre2-dev zlib1g-dev libssl-dev
          chmod +x auto/configure
          ./auto/configure \
            --prefix=/opt/nginx \
            --with-http_ssl_module \
            --with-http_v2_module \
            --with-http_realip_module \
            --with-http_stub_status_module \
            --with-stream \
            --with-stream_ssl_module \
            --with-stream_realip_module \
            --with-stream_ssl_preread_module
          make -j"$(nproc)"
          make install DESTDIR="$PWD/out"
          tar czf "${{ matrix.artifact_name }}" -C out .

      - name: Build on CentOS 8
        if: ${{ matrix.distro == 'centos' }}
        shell: bash
        run: |
          docker run --rm -v "$PWD":/src -w /src centos:8 bash -c "
            sed -i 's|mirrorlist=|#mirrorlist=|g' /etc/yum.repos.d/*.repo &&
            sed -i 's|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g' /etc/yum.repos.d/*.repo &&
            dnf clean all &&
            dnf -y groupinstall 'Development Tools' &&
            dnf install -y pcre2-devel zlib-devel openssl-devel &&
            chmod +x auto/configure &&
            ./auto/configure \
              --prefix=/opt/nginx \
              --with-http_ssl_module \
              --with-http_v2_module \
              --with-http_realip_module \
              --with-http_stub_status_module \
              --with-stream \
              --with-stream_ssl_module \
              --with-stream_realip_module \
              --with-stream_ssl_preread_module &&
            make -j\$(nproc) &&
            make install DESTDIR=/src/out
          "
          tar czf "${{ matrix.artifact_name }}" -C out .

      - name: Setup MSYS2
        if: ${{ matrix.distro == 'windows' }}
        uses: msys2/setup-msys2@v2
        with:
          msystem: MSYS
          update: false
          install: make

      - name: Build on Windows
        if: ${{ matrix.distro == 'windows' }}
        shell: cmd
        run: |
          :: Install Strawberry Perl via Chocolatey
          choco install -y strawberryperl --no-progress
          
          :: Set up Visual Studio environment
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvarsall.bat" x64
          
          :: Add Strawberry Perl to PATH first
          set "PATH=C:\Strawberry\perl\bin;C:\Strawberry\c\bin;%PATH%"
          
          :: Create directories
          mkdir objs\lib 2>nul
          mkdir logs 2>nul
          mkdir temp 2>nul
          
          :: Download dependencies
          echo Downloading PCRE2...
          curl -L -o objs\lib\pcre2.zip https://github.com/PCRE2Project/pcre2/releases/download/pcre2-10.44/pcre2-10.44.zip
          powershell -Command "Expand-Archive -Path objs\lib\pcre2.zip -DestinationPath objs\lib -Force"
          move objs\lib\pcre2-10.44 objs\lib\pcre2
          del objs\lib\pcre2.zip
          
          echo Downloading zlib...
          curl -L -o objs\lib\zlib.tar.gz https://github.com/madler/zlib/releases/download/v1.3.1/zlib-1.3.1.tar.gz
          tar -xzf objs\lib\zlib.tar.gz -C objs\lib
          move objs\lib\zlib-1.3.1 objs\lib\zlib
          del objs\lib\zlib.tar.gz
          
          echo Downloading OpenSSL...
          curl -L -o objs\lib\openssl.tar.gz https://github.com/openssl/openssl/releases/download/openssl-3.4.0/openssl-3.4.0.tar.gz
          tar -xzf objs\lib\openssl.tar.gz -C objs\lib
          move objs\lib\openssl-3.4.0 objs\lib\openssl
          del objs\lib\openssl.tar.gz

      - name: Configure nginx
        if: ${{ matrix.distro == 'windows' }}
        shell: msys2 {0}
        run: |
          auto/configure \
            --with-cc=cl \
            --prefix= \
            --conf-path=conf/nginx.conf \
            --pid-path=logs/nginx.pid \
            --http-log-path=logs/access.log \
            --error-log-path=logs/error.log \
            --sbin-path=nginx.exe \
            --http-client-body-temp-path=temp/client_body_temp \
            --http-proxy-temp-path=temp/proxy_temp \
            --http-fastcgi-temp-path=temp/fastcgi_temp \
            --http-scgi-temp-path=temp/scgi_temp \
            --http-uwsgi-temp-path=temp/uwsgi_temp \
            --with-cc-opt=-DFD_SETSIZE=1024 \
            --with-pcre=objs/lib/pcre2 \
            --with-zlib=objs/lib/zlib \
            --with-openssl=objs/lib/openssl \
            --with-openssl-opt=no-asm \
            --with-http_ssl_module \
            --with-http_v2_module \
            --with-http_realip_module \
            --with-http_stub_status_module \
            --with-stream \
            --with-stream_ssl_module \
            --with-stream_realip_module \
            --with-stream_ssl_preread_module

      - name: Build nginx
        if: ${{ matrix.distro == 'windows' }}
        shell: cmd
        run: |
          :: Set up Visual Studio environment
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvarsall.bat" x64
          set "PATH=C:\Strawberry\perl\bin;C:\Strawberry\c\bin;%PATH%"
          
          echo Building nginx...
          nmake
          
          :: Create output structure
          mkdir nginx-windows\logs 2>nul
          mkdir nginx-windows\temp 2>nul
          copy objs\nginx.exe nginx-windows\
          xcopy /E /I conf nginx-windows\conf
          xcopy /E /I docs\html nginx-windows\html

      - name: Package Windows build
        if: ${{ matrix.distro == 'windows' }}
        shell: pwsh
        run: |
          Compress-Archive -Path nginx-windows -DestinationPath "${{ matrix.artifact_name }}"

      - name: Upload binary to Release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ${{ matrix.artifact_name }}
          asset_name: ${{ matrix.artifact_name }}
          tag: ${{ matrix.tag }}